#!/usr/bin/env zsh

echo 'ğŸ“ Setting up prerequisites.'
mkdir -p $HOME/.cache/
# Set the context to this script's directory with `cd`.
# https://stackoverflow.com/a/59916
cd $(dirname $0)

echo 'ğŸ“» Adjusting correct directory permissions.'
# https://gist.github.com/oseme-techguy/bae2e309c084d93b75a9b25f49718f85
chmod u=rwx,go= $(realpath $(pwd)/../gnupg/)

echo 'ğŸ”— Symlinking scripts.'
for script in $(realpath $(pwd)/../bin/*); do
    sudo ln -s $script /usr/local/bin/$(basename $script)
done

echo 'ğŸ“€ Initializing and fetching data for Git submodules.'
# https://git-scm.com/book/en/v2/Git-Tools-Submodules#_cloning_submodules
git submodule init
git submodule update

# https://stackoverflow.com/a/677212
if ! command -v brew &>/dev/null; then
    echo 'ğŸº Installing Homebrew.'
    # https://brew.sh/#install
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    echo 'ğŸº Adding Homebrew to `$PATH` during setup.'
    # https://docs.brew.sh/Manpage#shellenv-bashcshfishpwshshtcshzsh
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi

echo 'ğŸ“¦ Installing Homebrew packages.'
BREWFILE_PATH=$(realpath $(pwd)/../brew/Brewfile)
# https://docs.brew.sh/Manpage#bundle-subcommand
brew bundle check --file $BREWFILE_PATH || brew bundle install --file $BREWFILE_PATH

echo 'ğŸ“ˆ Running `brew doctor`.'
brew doctor

echo 'ğŸ“¦ Installing asdf plugins.'
# Deno
asdf plugin add deno
asdf install deno latest
asdf global deno latest
# Node.js
asdf plugin add nodejs
asdf install nodejs latest
asdf global nodejs latest
# Ruby
asdf plugin add ruby
asdf install ruby latest
asdf global ruby latest
echo 'ğŸº Adding asdf plugins to `$PATH` during setup.'
# https://asdf-vm.com/guide/getting-started.html#_3-install-asdf
source $(brew --prefix asdf)/libexec/asdf.sh

echo 'ğŸ¹ Downloading EurKEY keyboard layout.'
sudo curl https://raw.githubusercontent.com/alexmick/EurKEY-Mac/main/EurKEY.keylayout --remote-name --output-dir /Library/Keyboard\ Layouts/ --silent
sudo curl https://raw.githubusercontent.com/alexmick/EurKEY-Mac/main/EurKEY.icns --remote-name --output-dir /Library/Keyboard\ Layouts/ --silent

# https://stackoverflow.com/a/677212
if ! command -v vimgolf &>/dev/null; then
    echo 'â›³ï¸ Installing VimGolf.'
    gem install vimgolf
    vimgolf setup
fi

SHELLS_PATH=/etc/shells
if ! grep --quiet fish $SHELLS_PATH; then
    echo 'ğŸ  Setting fish as the default shell.'
    # https://fishshell.com/docs/current/#default-shell
    echo $(which fish) | sudo tee -a $SHELLS_PATH
    chsh -s $(which fish)
fi

echo 'ğŸ“¶ (Re)starting SketchyBar service.'
brew services restart sketchybar

echo 'ğŸ« Autohiding the Dock and increasing the animation delay.'
# https://macos-defaults.com/dock/autohide.html
defaults write com.apple.dock "autohide" -bool "true"
# https://macos-defaults.com/dock/autohide-delay.html#set-to-0
defaults write com.apple.dock "autohide-delay" -float "999"
killall Dock

echo '=================================================================='
echo 'ğŸ’¡ Remember to manually set up and configure the following things:'
echo 'ğŸ”‘ GPG keys'
echo 'ğŸ macOS settings'
echo '=================================================================='

if [ $TERM != 'xterm-kitty' ]; then
    echo 'ğŸˆ Opening kitty terminal.'
    open -a kitty
fi
